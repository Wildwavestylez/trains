<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #playerPanel {
            flex: 1;
            padding: 10px;
            background-color: #f0f0f0;
        }

        #map {
            flex: 2;
            height: 50%;
        }

          
        
    </style>
    <title>Train Game</title>
</head>
<body>

<div id="playerPanel">
    <!-- Zde můžete umístit obsah hráčova panelu, např. portfolio, kupony vlaků, atd. -->
    <h2>Player Panel</h2>
    <p id="finance">Finance: 1000 Kč</p>
    <p>Kupony vlaků: 36</p>
    <p>Vlaky v provozu: 4</p>
    <!-- Doplnit další informace podle potřeby -->
</div>

<div id="map"></div>
<div id="map"></div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let playerFinance = 1000;
let availableLines = []; // Seznam dostupných linek
const trainSpeed = 500; // Rychlost vlaku v km/h
const updateInterval = 1000; // Interval aktualizace polohy vlaku v ms
const offerInterval = 60000; // Interval nabídek od herního drážního úřadu v ms

// Fiktivní data pro linky a zastávky
const lines = [
    {
        name: "Trať 198 Strakonice - Volary",
        color: "blue",
        trains: [
            { name: "Train 1", startingIndex: 0, reverse: false, image: 'https://i.imgur.com/C0nmEUE.png', maxSpeed: 100 },
            { name: "Train 2", startingIndex: 8, reverse: false, image: 'https://i.imgur.com/C0nmEUE.png', maxSpeed: 100 },
            { name: "Train 3", startingIndex: 14, reverse: true, image: 'https://i.imgur.com/C0nmEUE.png', maxSpeed: 100 },
            { name: "Train 4", startingIndex: 21, reverse: false, image: 'https://i.imgur.com/C0nmEUE.png', maxSpeed: 100 },
            { name: "Train 5", startingIndex: 7, reverse: true, image: 'https://i.imgur.com/C0nmEUE.png', maxSpeed: 100 },
            { name: "Train 6", startingIndex: 15, reverse: false, image: 'https://i.imgur.com/C0nmEUE.png', maxSpeed: 100 }
        ],
         stops: [
                { name: "Strakonice", location: [49.2551575, 13.9163047] },
                { name: "Radošovice", location: [49.2322158, 13.901812] },
                { name: "Přední Zborovice", location: [49.2183647, 13.8940200] },
                { name: "Strunkovice nad Volyňkou", location: [49.2100447, 13.8872928] },
                { name: "Hoštice", location: [49.1873397, 13.8930731] },
                { name: "Volyně", location: [49.1701164, 13.8928975] },
                { name: "Nišovice", location: [49.1502839, 13.9059867] },
                { name: "Malenice", location: [49.1237908, 13.8832197] },
                { name: "Lčovice", location: [49.1090089, 13.8666047] },
                { name: "Čkyně", location: [49.1111489, 13.8291083] },
                { name: "Bohumilice v Čechách, zastávka", location: [49.0975800, 13.8137817] },
                { name: "Bohumilice v Čechách", location: [49.0927086, 13.8010150] },
                { name: "Vimperk", location: [49.0555267, 13.7907544] },
                { name: "Vimperk, zastávka", location: [49.0487633, 13.7639522] },
                { name: "Lipka", location: [49.0202103, 13.7354764] },
                { name: "Kubova Huť", location: [48.9830017, 13.7747478] },
                { name: "Horní Vltavice", location: [48.9625625, 13.7746514] },
                { name: "Zátoň", location: [48.9509200, 13.8030072] },
                { name: "Zátoň - Boubín", location: [48.9515725, 13.8224831] },
                { name: "Lenora", location: [48.9283675, 13.7969542] },
                { name: "Lenora zastávka", location: [48.9233969, 13.8026581] },
                { name: "Soumarský Most", location: [48.9080047, 13.8287611] },
                { name: "Volary", location: [48.9070969, 13.8833131] },  
        ]
    }, 

        {
        name: "Trať 031 Pardubice  - Jaroměř",    
        color: "red",
        trains: [
            { name: "Train 7", startingIndex: 0, reverse: false, image: 'https://i.imgur.com/jXoYbZs.png', maxSpeed: 100 },
            { name: "Train 8", startingIndex: 14, reverse: false, image: 'https://i.imgur.com/jXoYbZs.png', maxSpeed: 100 },
            { name: "Train 9", startingIndex: 7, reverse: true, image: 'https://i.imgur.com/jXoYbZs.png', maxSpeed: 100 },
            { name: "Train 10", startingIndex: 7, reverse: false, image: 'https://i.imgur.com/jXoYbZs.png', maxSpeed: 100 },
        ],
        stops: [
              { name: "Pardubice Hlavní nádraží", location: [50.0318908, 15.7563753] },
                { name: "Pardubice - Rosice nad Laben", location: [50.0454825, 15.7424669] },
                { name: "Pardubice - Semtín", location: [50.0614931, 15.7479144] },
                { name: "Stéblová obec", location: [50.0928917, 15.7523633] },
                { name: "Stéblová", location: [50.1044083, 15.7576503] },
                { name: "Čeperka", location: [50.1314736, 15.7699281] },
                { name: "Opatovice nad Labem", location: [50.1562539, 15.7839042] },
                { name: "Opatovice nad Labem - Pohřebačka", location: [50.1653747, 15.7890414] },
                { name: "Hradec Králové, Hlavní nádraží", location: [50.2140617, 15.8101597] },
                { name: "Předměřice nad Labem", location: [50.2526511, 15.8177967] },
                { name: "Lochenice", location: [50.2729417, 15.8245219] },
                { name: "Smiřice", location: [50.3005256, 15.8582047] },
                { name: "Černožice", location: [50.3155061, 15.8695822] },
                { name: "Semonice", location: [50.3316458, 15.8774558] },
                { name: "Jaroměř", location: [50.3417397, 15.9101000] },
               
        ]
    },

      {
        name: "Trať 290 Olomouc  - Šumperk",    
        color: "green",
        trains: [
            { name: "Train 11", startingIndex: 0, reverse: false, image: 'https://i.imgur.com/1xGFDKV.png', maxSpeed: 100 },
            { name: "Train 12", startingIndex: 15, reverse: false, image: 'https://i.imgur.com/1xGFDKV.png', maxSpeed: 100 },
            { name: "Train 13", startingIndex: 7, reverse: true, image: 'https://i.imgur.com/1xGFDKV.png', maxSpeed: 100 },
            { name: "Train 14", startingIndex: 7, reverse: false, image: 'https://i.imgur.com/1xGFDKV.png', maxSpeed: 100 },
            
        ],
        stops: [
              { name: "Olomouc Hlavní nádraží", location: [49.5925828, 17.2783775] },
                { name: "Bohuňovice", location: [49.6624297, 17.2811833] },
                { name: "Štarnov", location: [49.6836967, 17.2847500] },
                { name: "Šternberk", location: [49.7205239, 17.2859458] },
                { name: "Babice u Šternberka", location: [49.7411536, 17.2685814] },
                { name: "Mladějovice", location: [49.7583808, 17.2352314] },
                { name: "Újezd u Uničova", location: [49.7751464, 17.1871147] },
                { name: "Uničov zastávka", location: [49.7775422, 17.1451092] },
                { name: "Uničov", location: [49.7792092, 17.1159192] },
                { name: "Troubelice střed", location: [49.8132172, 17.0763244] },
                { name: "Troubelice zastávka", location: [49.8256225, 17.0673064] },
                { name: "Nová Hradečná", location: [49.8357544, 17.0723056] },
                { name: "Libina", location: [49.8785706, 17.0622119] },
                { name: "Hrabišín", location: [49.9080125, 17.0384942] },
                { name: "Nový Malín", location: [49.9458733, 17.0344125] },
                { name: "Šumperk", location: [49.9617958, 16.9831067] },
               
        ]
    },
    // Další linky můžete přidávat podle potřeby
];

// Inicializace mapy Leaflet
const map = L.map('map').setView([49.25, 13.91], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// Skrytí linek na začátku hry
lines.forEach(line => {
    line.hidden = true;
    availableLines.push(line);
});

// Funkce pro zobrazování nabídek od herního drážního úřadu
function showRandomOffer() {
    const randomLineIndex = Math.floor(Math.random() * availableLines.length);
    const offerLine = availableLines[randomLineIndex];

    if (confirm(`Herní drážní úřad nabízí provozování linky: ${offerLine.name} za 1000 Kč. Chcete ji koupit?`)) {
        if (playerFinance >= 1000) {
            playerFinance -= 1000;
            document.getElementById('finance').innerText = `Finance: ${playerFinance} Kč`;

            offerLine.hidden = false;
            availableLines.splice(randomLineIndex, 1);

            // Přidání ikon a logiky pro nově zakoupenou linku (kód zůstává stejný, jen se zobrazí)
            let polyline = L.polyline(offerLine.stops.map(stop => stop.location), { color: offerLine.color }).addTo(map);
            polyline.bindPopup(offerLine.name);

            offerLine.trains.forEach(train => {
                let trainIcon = L.icon({
                    iconUrl: 'https://i.imgur.com/jXoYbZs.png',
                    iconSize: [100, 100],
                    iconAnchor: [50, 50],
                    popupAnchor: [0, 0]
                });

                let trainMarker = L.marker(offerLine.stops[train.startingIndex].location, { icon: trainIcon }).addTo(map);
                trainMarker.bindPopup(train.name);

                train.marker = trainMarker;
                moveTrain(train, offerLine);
            });

            let stopIcon = L.icon({
                iconUrl: 'https://i.imgur.com/EDFZjPX.png',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, 0]
            });

            offerLine.stops.forEach(stop => {
                L.marker(stop.location, { icon: stopIcon }).addTo(map).bindPopup(stop.name);
            });
        } else {
            alert("Nemáte dostatek financí na nákup linky.");
        }
    }
}

// Funkce pro pohybující se ikony vlaků pouze pro nově odemčené linky
function moveTrain(train, line) {
    let currentStopIndex = train.startingIndex;
    let direction = train.reverse ? -1 : 1; // Směr pohybu vlaku (1 = dopředu, -1 = zpět)
    let startTime = new Date();

    setInterval(() => {
        const currentStop = line.stops[currentStopIndex];
        const nextStop = line.stops[currentStopIndex + direction];

        if (nextStop) {
            const distanceToNextStop = getDistance(currentStop.location[0], currentStop.location[1], nextStop.location[0], nextStop.location[1]);
            const timeToNextStop = distanceToNextStop / trainSpeed; // v hodinách

            const currentTime = new Date();
            const elapsedTime = (currentTime - startTime) / 1000 / 60 / 60; // v hodinách

            if (elapsedTime <= timeToNextStop) {
                const lat = currentStop.location[0] + (nextStop.location[0] - currentStop.location[0]) * (elapsedTime / timeToNextStop);
                const lon = currentStop.location[1] + (nextStop.location[1] - currentStop.location[1]) * (elapsedTime / timeToNextStop);
                train.marker.setLatLng([lat, lon]);
            } else {
                // Přesun na další/zpětnou zastávku
                currentStopIndex += direction;
                startTime = new Date();

                // Pokud jsme dosáhli konce nebo začátku trasy, změníme směr pohybu
                if (currentStopIndex === 0 || currentStopIndex === line.stops.length - 1) {
                    direction *= -1;
                    giveRandomMoneyToPlayer(); // Získání peněz při dosažení zastávky
                }
            }
        } else {
            // Dosáhli jsme konce trasy, změňme směr pohybu
            direction *= -1;
            currentStopIndex += direction;
            giveRandomMoneyToPlayer(); // Získání peněz při dosažení konce trasy
        }
    }, updateInterval);
}

// Spuštění nabídek od herního drážního úřadu každou minutu
setInterval(showRandomOffer, offerInterval);




    
// Funkce pro udělení náhodné finanční částky hráči při dosažení zastávky
function giveRandomMoneyToPlayer() {
    const randomAmount = generateRandomAmount();
    playerFinance += randomAmount;
    document.getElementById('finance').innerText = `Finance: ${playerFinance} Kč`;
}

function generateRandomAmount() {
    return Math.floor(Math.random() * (500 - 300 + 1)) + 300;
}

// Změny v moveTrain funkci
function moveTrain(train, line) {
    let currentStopIndex = train.startingIndex;
    let direction = train.reverse ? -1 : 1; // Směr pohybu vlaku (1 = dopředu, -1 = zpět)
    let startTime = new Date();

    setInterval(() => {
        const currentStop = line.stops[currentStopIndex];
        const nextStop = line.stops[currentStopIndex + direction];

        if (nextStop) {
            const distanceToNextStop = getDistance(currentStop.location[0], currentStop.location[1], nextStop.location[0], nextStop.location[1]);
           const timeToNextStop = distanceToNextStop / train.maxSpeed; // v hodinách

            const currentTime = new Date();
            const elapsedTime = (currentTime - startTime) / 1000 / 60 / 60; // v hodinách

            if (elapsedTime <= timeToNextStop) {
                const lat = currentStop.location[0] + (nextStop.location[0] - currentStop.location[0]) * (elapsedTime / timeToNextStop);
                const lon = currentStop.location[1] + (nextStop.location[1] - currentStop.location[1]) * (elapsedTime / timeToNextStop);
                train.marker.setLatLng([lat, lon]);
            } else {
                // Přesun na další/zpětnou zastávku
                currentStopIndex += direction;
                startTime = new Date();

                // Pokud jsme dosáhli konce nebo začátku trasy, změníme směr pohybu
                if (currentStopIndex === 0 || currentStopIndex === line.stops.length - 1) {
                    direction *= -1;
                    giveRandomMoneyToPlayer(); // Získání peněz při dosažení zastávky
                }
            }
        } else {
            // Dosáhli jsme konce trasy, změňme směr pohybu
            direction *= -1;
            currentStopIndex += direction;
            giveRandomMoneyToPlayer(); // Získání peněz při dosažení konce trasy
        }
    }, updateInterval);
}

// Vypočítá vzdálenost mezi dvěma zastávkami
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // poloměr Země v km
    const dLat = toRadians(lat2 - lat1);
    const dLon = toRadians(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c; // vzdálenost v km
    return distance;
}

// Převádí stupně na radiány
function toRadians(degrees) {
    return degrees * Math.PI / 180;
}

</script>

</body>
</html>
